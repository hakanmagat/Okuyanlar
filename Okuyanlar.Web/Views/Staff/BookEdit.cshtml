@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model Okuyanlar.Core.Entities.Book

@{
    ViewData["Title"] = "Edit Book";
}

<div class="ok-section" style="padding-top:2rem; padding-bottom:2rem;">
    <div class="container ok-container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">

                <div class="ok-card">
                    <!-- Header -->
                    <div class="ok-card-header" style="display:flex; align-items:center; justify-content:space-between;">
                        <div style="display:flex; align-items:center; gap:.75rem;">
                            <div style="
                                width:44px;height:44px;border-radius:12px;
                                background: rgba(197,160,89,.18);
                                display:flex;align-items:center;justify-content:center;
                                border:1px solid rgba(255,255,255,.16);
                            ">
                                <i class="bi bi-pencil-square" style="font-size:1.2rem; color:#fff;"></i>
                            </div>
                            <div>
                                <div style="font-size:1.1rem; font-weight:900; line-height:1.2;">Edit Book Details</div>
                                <div style="opacity:.9; font-weight:700; font-size:.9rem;">Update metadata & availability</div>
                            </div>
                        </div>

                        <span class="ok-badge ok-badge-accent" style="font-weight:900;">
                            Inventory
                        </span>
                    </div>

                    <!-- Body -->
                    <div class="ok-card-body">
                        <form asp-action="BookEdit" method="post" id="bookEditForm" enctype="multipart/form-data">
                            @Html.AntiForgeryToken()

                            <input type="hidden" asp-for="Id" />
                            <div asp-validation-summary="ModelOnly" class="text-danger mb-3" style="font-weight:800;"></div>

                            <div class="row">
                                <div class="col-md-6 ok-mb-3">
                                    <label asp-for="Title" class="ok-form-label">Book Title</label>
                                    <input asp-for="Title" class="ok-form-control" placeholder="e.g. Clean Code" />
                                    <span asp-validation-for="Title" class="text-danger small" style="font-weight:800;"></span>
                                </div>

                                <div class="col-md-6 ok-mb-3">
                                    <label asp-for="Author" class="ok-form-label">Author</label>
                                    <input asp-for="Author" class="ok-form-control" placeholder="e.g. Robert C. Martin" />
                                    <span asp-validation-for="Author" class="text-danger small" style="font-weight:800;"></span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 ok-mb-3">
                                    <label asp-for="ISBN" class="ok-form-label">ISBN</label>
                                    <input asp-for="ISBN" class="ok-form-control" placeholder="978-..." />
                                    <span asp-validation-for="ISBN" class="text-danger small" style="font-weight:800;"></span>
                                </div>

                                <div class="col-md-6 ok-mb-3">
                                    <label asp-for="Stock" class="ok-form-label">Stock</label>
                                    <input asp-for="Stock" class="ok-form-control" type="number" min="0" />
                                    <span asp-validation-for="Stock" class="text-danger small" style="font-weight:800;"></span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 ok-mb-3">
                                    <label asp-for="ShelfLocation" class="ok-form-label">Shelf Location (optional)</label>
                                    <input asp-for="ShelfLocation" class="ok-form-control" placeholder="e.g. A3-05, Section B, Shelf 12" />
                                    <small style="opacity:.75; font-weight:800;">Physical location of the book in the library</small>
                                    <span asp-validation-for="ShelfLocation" class="text-danger small" style="font-weight:800;"></span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 ok-mb-3">
                                    <label asp-for="Description" class="ok-form-label">Description (optional)</label>
                                    <textarea asp-for="Description" class="ok-form-control" rows="4" placeholder="Brief description or synopsis of the book..."></textarea>
                                    <small style="opacity:.75; font-weight:800;">A detailed description or synopsis of the book</small>
                                    <span asp-validation-for="Description" class="text-danger small" style="font-weight:800;"></span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 ok-mb-3">
                                    <label class="ok-form-label">Cover Image</label>

                                    <!-- Current Image Preview -->
                                    @if (!string.IsNullOrWhiteSpace(Model.CoverUrl))
                                    {
                                        <div class="ok-flex ok-gap-3 ok-flex-wrap ok-items-center ok-mb-3">
                                            <img src="@Model.CoverUrl" alt="@Model.Title cover" style="width:120px; height:160px; object-fit:cover; border-radius:8px;" onerror="this.src='/images/book-placeholder.jpg'" />
                                            <div>
                                                <div style="font-weight:800; opacity:.9;">Current Image</div>
                                                <small style="opacity:.75; font-weight:800;">
                                                    @if (Model.CoverUrl?.StartsWith("http://", StringComparison.OrdinalIgnoreCase) == true || 
                                                         Model.CoverUrl?.StartsWith("https://", StringComparison.OrdinalIgnoreCase) == true)
                                                    {
                                                        <span>External URL</span>
                                                    }
                                                    else
                                                    {
                                                        <span>Uploaded File</span>
                                                    }
                                                </small>
                                            </div>
                                            <button type="submit"
                                                    class="btn-ok-danger"
                                                    formaction="@Url.Action("RemoveBookCover", "Staff")"
                                                    formmethod="post"
                                                    formnovalidate
                                                    data-bypass-validation="true"
                                                    onclick="return confirm('Remove current cover image?');">
                                                <i class="bi bi-trash me-1"></i> Remove Cover
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="ok-flex ok-gap-3 ok-flex-wrap ok-items-center ok-mb-3">
                                            <div class="ok-no-image ok-no-image-border" style="width:120px; height:160px; border-radius:8px; font-size:.8rem;">NO IMAGE</div>
                                        </div>
                                    }

                                    <!-- Image Source Toggle -->
                                    <div class="ok-card ok-mb-3" style="box-shadow: var(--ok-shadow-sm); border-radius:14px;">
                                        <div class="ok-card-body" style="padding: 1rem 1.25rem;">
                                            <div class="ok-flex ok-items-center ok-justify-between ok-flex-wrap ok-gap-2">
                                                <div>
                                                    <div style="font-weight:900; color:var(--ok-title);">
                                                        Update Image Source
                                                    </div>
                                                    <div style="opacity:.8; font-weight:700; font-size:.9rem;">
                                                        Choose between uploading a file or providing a URL
                                                    </div>
                                                </div>

                                                <div class="form-check form-switch" style="margin:0;">
                                                    <input type="checkbox" class="form-check-input" id="useUrlSwitch" />
                                                    <label class="form-check-label" for="useUrlSwitch" style="font-weight:800;">
                                                        Use URL
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- File Upload Section -->
                                    <div id="uploadSection">
                                        <input type="file" name="coverImage" id="coverImageFile" class="ok-form-control" accept="image/*" />
                                        <small style="opacity:.75; font-weight:800;">Upload to replace. Max 5 MB.</small>
                                    </div>

                                    <!-- URL Input Section -->
                                    <div id="urlSection" style="display:none;">
                                        <input type="url" name="coverImageUrl" id="coverImageUrl" class="ok-form-control" placeholder="https://example.com/image.jpg" />
                                        <small style="opacity:.75; font-weight:800;">Enter a direct URL to an image (must start with http:// or https://)</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Availability toggle -->
                            <div class="ok-card ok-mt-2" style="box-shadow: var(--ok-shadow-sm); border-radius:14px;">
                                <div class="ok-card-body" style="padding: 1rem 1.25rem;">
                                    <div class="ok-flex ok-items-center ok-justify-between ok-flex-wrap ok-gap-2">
                                        <div>
                                            <div style="font-weight:900; color:var(--ok-title);">
                                                Availability
                                            </div>
                                            <div style="opacity:.8; font-weight:700; font-size:.9rem;">
                                                Control whether this book can be borrowed.
                                            </div>
                                        </div>

                                        <div class="form-check form-switch" style="margin:0;">
                                            <input asp-for="IsActive" class="form-check-input" id="isActiveSwitch" />
                                            <label class="form-check-label" for="isActiveSwitch" style="font-weight:800;">
                                                Is Available?
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="ok-mt-4 ok-flex ok-justify-between ok-items-center ok-gap-2 ok-flex-wrap">
                                <a asp-action="BookManage" class="btn-ok-secondary" style="text-align:center; min-width:160px;">
                                    <i class="bi bi-x-circle me-2"></i> Cancel
                                </a>

                                <button type="submit" class="btn-ok-primary" style="min-width:200px;">
                                    <i class="bi bi-check2-circle me-2"></i> Update Details
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Footer -->
                    <div class="ok-card-footer" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:.75rem;">
                        <small style="opacity:.75; font-weight:800;">Changes are saved immediately after update.</small>
                        <small style="opacity:.75; font-weight:800;">Okuyanlar â€¢ Staff Tools</small>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Toggle between file upload and URL input
        document.addEventListener("DOMContentLoaded", function () {
            var form = document.getElementById("bookEditForm");
            if (!form) return;

            var useUrlSwitch = document.getElementById("useUrlSwitch");
            var uploadSection = document.getElementById("uploadSection");
            var urlSection = document.getElementById("urlSection");
            var fileInput = document.getElementById("coverImageFile");
            var urlInput = document.getElementById("coverImageUrl");

            useUrlSwitch.addEventListener("change", function () {
                if (this.checked) {
                    uploadSection.style.display = "none";
                    urlSection.style.display = "block";
                    fileInput.value = "";
                    fileInput.removeAttribute("required");
                } else {
                    uploadSection.style.display = "block";
                    urlSection.style.display = "none";
                    urlInput.value = "";
                    urlInput.removeAttribute("required");
                }
            });

            form.addEventListener("submit", function (e) {
                var submitter = e.submitter || null;
                var bypass = submitter && submitter.dataset && submitter.dataset.bypassValidation === 'true';
                if (!bypass && window.OkValidation && !OkValidation.validate(form)) {
                    e.preventDefault();
                    if (window.OkToast) OkToast.error("Please check the form fields.", "Validation");
                    return;
                }
                if (window.OkLoading) OkLoading.show();
            });
        });
    </script>
}
