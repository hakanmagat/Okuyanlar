@using System.Security.Claims
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model Okuyanlar.Web.Models.CreateUserViewModel

@{
    ViewData["Title"] = "Create New Staff/User";
    var currentOperator = User?.Identity?.Name ?? "Unknown";
    var currentRole = User?.FindFirst(ClaimTypes.Role)?.Value ?? "Unknown";
}

<div class="ok-section" style="padding-top: 2rem; padding-bottom: 2rem;">
    <div class="container ok-container">
        <div class="row justify-content-center">
            <div class="col-lg-7 col-md-9">

                <div class="ok-card">
                    <div class="ok-card-header" style="display:flex; align-items:center; justify-content:space-between;">
                        <div style="display:flex; align-items:center; gap:.75rem;">
                            <div style="
                                width:44px;height:44px;border-radius:12px;
                                background: rgba(197,160,89,.18);
                                display:flex;align-items:center;justify-content:center;
                                border:1px solid rgba(255,255,255,.18);
                            ">
                                <i class="bi bi-person-plus" style="font-size:1.25rem; color:#fff;"></i>
                            </div>

                            <div>
                                <div style="font-size:1.1rem; font-weight:900; line-height:1.2;">Create New User</div>
                                <div style="opacity:.9; font-weight:700; font-size:.9rem;">Admin / Staff onboarding</div>
                            </div>
                        </div>

                        <span class="ok-badge ok-badge-accent" style="font-weight:900;">Admin Panel</span>
                    </div>

                    <div class="ok-card-body">
                        <!-- Operator info -->
                        <div class="ok-card" style="box-shadow: var(--ok-shadow-sm); border-radius:14px;">
                            <div class="ok-card-body" style="padding: 1rem 1.25rem;">
                                <div class="ok-flex ok-items-center ok-gap-2">
                                    <div style="
                                        width:48px;height:48px;border-radius:14px;
                                        background: var(--ok-accent);
                                        display:flex;align-items:center;justify-content:center;
                                        color: var(--ok-stroke);
                                        flex-shrink:0;
                                    ">
                                        <i class="bi bi-person-badge" style="font-size:1.4rem;"></i>
                                    </div>

                                    <div class="ok-flex ok-flex-col" style="gap:.1rem;">
                                        <small style="opacity:.7; font-weight:800;">Authorized Operator</small>
                                        <div style="font-weight:900; color: var(--ok-title);">
                                            @currentOperator
                                            <span class="ok-badge ok-badge-secondary" style="margin-left:.5rem;">@currentRole</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Success Toast/Alert (TempData) -->
                        @if (TempData["SuccessMessage"] != null)
                        {
                            <div class="ok-card ok-mt-3" style="border-left:6px solid rgba(92,184,92,.85);">
                                <div class="ok-card-body" style="padding: 1rem 1.25rem;">
                                    <div class="ok-flex ok-items-center ok-gap-2">
                                        <i class="bi bi-check-circle-fill" style="font-size:1.25rem; color:#5cb85c;"></i>
                                        <div style="font-weight:900;">@TempData["SuccessMessage"]</div>
                                    </div>
                                </div>
                            </div>

                            <script>
                                // Eğer site.js içindeki OkToast kullanıyorsan otomatik toast da basalım:
                                document.addEventListener("DOMContentLoaded", function () {
                                    if (window.OkToast) {
                                        OkToast.success("@TempData["SuccessMessage"]", "Success");
                                    }
                                });
                            </script>
                        }

                        <div class="ok-mt-3">
                            <form asp-action="UserCreate" method="post" id="createUserForm">
                                @Html.AntiForgeryToken()

                                <div asp-validation-summary="ModelOnly" class="text-danger mb-3" style="font-weight:800;"></div>

                                <div class="ok-mb-3">
                                    <label asp-for="Username" class="ok-form-label"></label>
                                    <input asp-for="Username" class="ok-form-control" placeholder="e.g. library_staff_1" />
                                    <span asp-validation-for="Username" class="text-danger small" style="font-weight:800;"></span>
                                </div>

                                <div class="ok-mb-3">
                                    <label asp-for="Email" class="ok-form-label"></label>
                                    <input asp-for="Email" class="ok-form-control" placeholder="e.g. staff@okuyanlar.com" />
                                    <span asp-validation-for="Email" class="text-danger small" style="font-weight:800;"></span>
                                </div>

                                <div class="ok-mb-4">
                                    <label asp-for="Role" class="ok-form-label"></label>
                                    <select asp-for="Role" asp-items="Model.AllowedRoles" class="ok-form-control">
                                        <option value="">-- Select Role --</option>
                                    </select>

                                    <div class="form-text" style="font-weight:800; opacity:.75;">
                                        Available roles depend on your authorization level.
                                    </div>

                                    <span asp-validation-for="Role" class="text-danger small" style="font-weight:800;"></span>
                                </div>

                                <div class="ok-flex ok-flex-col ok-gap-2">
                                    <button type="submit" class="btn-ok-primary" style="width:100%;">
                                        <i class="bi bi-person-plus-fill me-2"></i> Create User & Send Email
                                    </button>

                                    <a asp-controller="Home" asp-action="Index"
                                       class="btn-ok-secondary"
                                       style="width:100%; text-align:center;">
                                        Return to Home
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="ok-card-footer" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:.75rem;">
                        <small style="opacity:.75; font-weight:800;">
                            Tip: Use strong usernames and role-based access.
                        </small>
                        <small style="opacity:.75; font-weight:800;">
                            Okuyanlar • Admin Tools
                        </small>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // İsteğe bağlı: form submit öncesi mini doğrulama + loading
        document.addEventListener("DOMContentLoaded", function () {
            var form = document.getElementById("createUserForm");
            if (!form) return;

            form.addEventListener("submit", function (e) {
                // Eğer site.js içindeki OkValidation varsa kullan
                if (window.OkValidation && !OkValidation.validate(form)) {
                    e.preventDefault();
                    if (window.OkToast) OkToast.error("Please check the form fields.", "Validation");
                    return;
                }

                if (window.OkLoading) OkLoading.show();
            });
        });
    </script>
}
